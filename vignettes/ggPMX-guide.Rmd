---
title: "ggPMX - User guide"
author: "Amine Gassem"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{ggPMX: User guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
    
```{r load_package, echo=FALSE}
opts_chunk$set(out.width='100%')

library(ggPMX)
#WORK_DIR <- "../ggpmx_files/inputs"
theophylline <- file.path(system.file(package = "ggPMX"), "testdata", 
                          "theophylline")
WORK_DIR <- file.path(theophylline, "Monolix")
input_file <- file.path(theophylline, "data_pk.csv")


```

## Introduction

This document serves as the main overview of the `ggPMX` package. It explains the hows and whys of the design decisions using clear examples.


## Basic workflow

- Generate inputs files for ggPMX package and store them in the same location.
- Create a controller: this object contains a number of different data sets , plots and other object like report settings and default plot settings.
- Use the controller (populated with different plots and other objects) to create custom reports.
- (Optional) Use `set_plot` to generate new plots.
- (Optional) Use `pmx_update` to modify the controller objects: plots/data sets.
- (Optional) Use `pmx_filter` to filter data stored in the controller object.

## The controller

A diagnostic session starts by creating controller using `pmx`. The controller is a general container that defines data configuration but may also contain generated objects like plots and tables. The `pmx` takes a `configuration` as one of its arguments.
A set of pre-built configurations can be listed using :

```{r list_configs}
configs()
```

Then we can instantiate a **standing** (the name of the config) controller using:
```{r init_controller}
ctr <- pmx(config = "standing", sys = "mlx", directory = WORK_DIR, 
           input = input_file, dv = "Y")
```

This is can be simplified by setting a number of global options and using the
Monolix controller:

- Setting the working directory using ggPMX options at the begining of the session. It is good practice in general to set global variables at the begining of the session.
- Using the MONOLIX controller.

```{r init_work_dir}
pmxOptions(
  work_dir = WORK_DIR, 
  input = input_file, 
  dv = "Y")
ctr <- pmx_mlx(config = "standing")

```


## Source

Behind the scene, when the controller is initialized it will create a source containing all data sets. The source is configured using a configuration object. In the previous example, we just gave the name of the configuration. `ggPMX` will use this name to guess the full path of the configuration file and load the corresponding data sets.

### Source configuration file

Source configuration are `yaml` files. `ymal` is human readable format. This is standard way to set configuration files and it is used in many popular R packages (`rmarkdown`, `htmlwidgets`). This is also the way the DESCRIPTION file of a package is defined. 

Basically, a source is a list of data sets. Each data set may contain one of the following fileds: 

- **label** : The name of the data set. This is can be helpful in the reporting.
- **file**  : the name of the file where to extract data
- **names**(Optional) : key value format of the columns/variable names. We can also set names as a character vector to set all column names.
- **reader**(Optional): In case of complex file, a custom reader function should be provided to tell the parser how to load the file. For the moment, only internal function can be used. This feature should be extended to allow advanced users to define their custom parser.

Here an example of yaml configuration used to read the model predictions of MONOLIX.
We indicate :

- The file name 
- The custom reader used to read this special file 
- The names to do the mapping between  MONOLIX/ggPMX naming conventions. Note that upper-case names for variables are used by convention within ggPMX package.

```{r, eval=FALSE}
    label : model predictions
    file  : MLX_predictions.txt
    reader  : read_mlx_pred
    names:
      id: ID
      time: TIME
      y1: DV
      poppred: PRED
      npde: NPDE
```



### Load the configuration

In practice there is no need to load the configuration. This is done internally within the controller. In some cases it can be interesting to load the configuration and modify some attributes like columns names for example:

```{r load_conf}

conf <- load_config("standing", sys = "mlx")
conf

```

`conf` is a list containing a the configuration of each data set and plots. 
We can change this configuration object by accessing the object as a list object. 

For example to change the mapping from `c("time","TIME")` to `c("time1","TIME")` We can do something like :
```{r change_mapping}

conf$data$mod_pred$names$time <- NULL
conf$data$mod_pred$names$time1 <- "TIME"

```

We will make this easier in next versions by defining wrappers function within the controller.  


```{r change_mapping_future, eval=FALSE}

# The following does not run - TODO: Fix it
#ctr %>% rename("time","time1")
#ctr %>% rename("mod_pred","time","time1")

```

## Plots

The `ggPMX` package allows a number of different plotting types to be
specified by the user. Currently these include the `Distribution plot`, the
`Individual plot` and the `Residual plot`.

In the following sections it will be assummed that appropriate global options 
have been set for the working directory, input file etc. and that a 
suitable controller has been defined. For users looking to replicate plots
a set up as follows can be assummed:

```{r, eval=FALSE}
library(ggPMX)
theophylline <- file.path(system.file(package = "ggPMX"), "testdata", 
                          "theophylline")
WORK_DIR <- file.path(theophylline, "Monolix")
input_file <- file.path(theophylline, "data_pk.csv")
pmxOptions(
  work_dir = WORK_DIR, 
  input = input_file, 
  dv = "Y")
ctr <- pmx_mlx(config = "standing")

```


### Graphical parameters 

Graphical parameters in `ggPMX` are set internally using the `pmx_gpar` function. A number of graphical paramters can be set for the different
plot types. 

```{r pmx_gpar_args}
args(pmx_gpar)
```
More information can be found in the help document `?pmx_gpar` and in the 
examples that follow.

### Plot types

#### Distribution plot

The `Distribution plot` plots the EBE distribution.

```{r , distribut,  fig.width=7, fig.height=6, warning=FALSE}
library(ggPMX)

ctr %>% set_plot("DIS", pname = "distr1", type = "box")

ctr %>% get_plot("distri")

```

#### Individual plot

```{r , individual_plot,  fig.width=7, fig.height=6, warning=FALSE}
library(ggPMX)

ctr %>% set_plot("IND", pname = "indiv1", 
                 draft = list(size = 10, label = "DRAFT", color = "grey50"))

ctr %>% get_plot("indiv1", c(2, 4))

```


#### Residual plot

The `Residual plot` plots a residual Y versus an independant variable X.
Examples of such are NPD vs EPRED, NPD vs TIME etc. 

```{r , residual_plot,  fig.width=7, fig.height=6}
library(ggPMX)

ctr %>% set_plot("RES", pname = "res1", y = "IWRES", x = "IPRED")

ctr %>% get_plot("res1")

```

## Complete example

In this section we introduce a complete example that illustrates the
workflow using the `ggPMX` package. Steps taken include: 

- Initializing the working dir and related quantities
- Creating the controller using the **standing** configuration
- Adding a new plot
- Printing all the plots


```{r complete_example, warning=FALSE,  fig.width=7, fig.height=6}
library(ggPMX)

## define a working dir
# Example that points to file in user's work directory
# Commented because the vignette will not build if it is on:
# pmxOptions(work_dir="/home/agstudy/projects/r/ggPMX/ggPMX_files/inputs")

theophylline <- file.path(system.file(package = "ggPMX"), "testdata", "theophylline")
WORK_DIR <-  file.path(theophylline, "Monolix")
input_file <- file.path(theophylline,"data_pk.csv")
pmxOptions(
  work_dir=WORK_DIR,
  input=input_file,
  dv="Y")

ctr <- pmx_mlx(config = "standing")


## add a new plot
ctr %>%
   set_plot(ptype="DIS",
            pname="distri_box",
            type="box",
            has.shrink=TRUE,
            has.jitter=FALSE)

## return all plots
lapply(ctr %>% plot_names,
       function(x){
        if(x=="indiv") return(ctr%>%get_plot(x, c(2, 4)))
         ctr %>% get_plot(x)
       })



```




## Additional considerations

### Filtering data

The `pmx_filter` function allows a user to filter a named data set.
Here we filter on the condition that ID is less than or equal to five:

```{r pmx_filter,  fig.width=7, fig.height=6}
plotnames <- ctr %>% plot_names()
ctr %>% 
  pmx_filter(data_set = "ind_pred", ID <= 5) %>% 
  get_plot(plotnames[1])
  

```

### Updating plots

Plots can be updated using the `pmx_update` function.
