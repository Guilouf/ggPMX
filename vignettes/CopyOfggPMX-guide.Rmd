---
title: "ggPMX - User guide"
author: "Amine Gassem"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{ggPMX: User guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
\clearpage  
```{r load_package, echo=FALSE,warning=FALSE,message=FALSE}
knitr::opts_chunk$set(out.width='100%',warning=FALSE,message=FALSE)
library(ggPMX)
```



# Introduction

ggPMX is an R package that generates standard model diagnostic plots and tables used in PMX activities.
This vignette introduces the ggPMX syntax, how to initialize a controller using package data , display plots, update existing plots , filter data , stratification and many others details. 

# Plots table

The main target of ggPMX is to create a report containing the following plots: 

```{r plots_list,echo=FALSE}

out <- rbind(
c("Plot of weighted residuals versus population predictions","RES","wres_ppred"),
c("Plot of weighted residuals versus time","RES","wres_time"),
c("Plot of IWRES versus time","RES","iwres_time"),
c("Plot of observations versus population predictions", "RES","dv_ppred"),
c("Plot of observations versus individual predictions", "RES","dv_ipred"),
c("Plot of absolute individual weighted residuals versus individual predictions","RES","abs_iwres_dv"),
c("Plot of individual weighted residuals (IWRES) versus individual predictions","RES","iwres_ipred"),
c("Plots of observations and model predictions per individual","IND","indiv"),
c("Distribution of EBE histogram","DIS","hist_ebe"),
c("Distribution of EBE boxplot","DIS","box_ebe"),
c("Distribution and quantile-quantile plot of IWRES","QQ","qq_iwres"),
c("Visual predictive check (VPC)","VPC","vpc"),
c("Distribution and correlation structure (ETA)","ECORREL","eta_correl"),
c("Relationships between (ETA) and covariates","ECORREL","eta_correl1"))
colnames(out) <- c("Plot Name","ggPMX type","ggPMX name")
knitr::kable(out)
```




# theophylline Use case 

In this vignette, we will use theophylline data. 

*PS: (TODO add some description of the data here, PK case,...)*


##  Start point: create a controller 

Within `ggPMX`, the first thing to do is to create a controller. 

To create a controller using `theophylline` we call the helper function:
```{r theophylline_ctr}
ctr <- theophylline()
```
Let's discover the controller content by printing to the console:
```{r display ctr}
ctr
```
We get mainly 3 tables:

- Table of the controller configutration 
- Table of data sets
- Table of plots. 

**Note that**:

* We will go in depeth through the controller details when we create a controller using custom data.
* The ctr is an object of class `r class(ctr)[1]`. It behaves like a container that stores: 
    + data configuration, 
    + plots configuration
    + data sets
    + plots
    + templates path.
    + report

## Get Plots

The controller is a container that stores all plots. To get the list of plots:

```{r plot_lists}
ctr %>% plot_names
```
Note here the use of piping 

To view a particular plot we call `get_plot` with the name of the plot:
```{r get_ipred_iwres}
ctr %>% get_plot("ipred_iwres")
```


In case of individual plots, We can pass in addition the number of page to plot to `get_plot`:

```{r ind_plots}
ctr %>% get_plot("indiv",npage = 2)
```

`get_plot` returns a standard `ggplot2` object that you can ucstomize using and valid `ggplot2` operation. Here for example: 

```{r ebe_plots}
ctr %>% get_plot("ebe_hist")
ctr %>% get_plot("ebe_box")
```


# ggPMX main functions

`ggPMX` implements few functions to generate diagnostic plots:

1. `pmx` creates a controller.
2. `plot_names` lists controller plots
3. `get_data` lists controller data
3. `get_plot` prints a plot
4. `set_plot` creates a new plot
5. `pmx_update` updates controller to modify an an existing plot
6. `pmx_filter` filters data stored in the controller object.

The design of the package is around the central object the controller that we can introspect (pipe) it using the `%>%`. 


