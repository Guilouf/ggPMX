---
title: "Sim_BLQ"
author: "Seid Hamzic"
date: "10/12/2020"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE}
rm(list=ls(all=TRUE))

#andrejs stuff
base<-"/home/biencan1"
working.dir <- file.path(base,"ggPMX_VPC")
script.dir <- file.path(base,"ggPMX_VPC")

model<-"FIT8"
model.dir<-file.path(working.dir,model)

data<-"mt83967_PK_IGNORE_1BLQ_C2201.csv"
#data<-"mt83967_PK_IGNORE_1BLQ_C2201_C2201E1.csv"
input.data<-file.path(model.dir,data)

odel<-"FIT24"
model.dir<-file.path(working.dir,model)

#data<-"mt83967_PK_IGNORE_1BLQ_C2201.csv"
#data<-"mt83967_PK_IGNORE_1BLQ_C2201_C2201E1.csv"
#input.data<-file.path(model.dir,data)

mlxtran_path<-file.path(model.dir,paste0(model,".mlxtran"))
vpc_file<-file.path(model.dir,paste0(model,"_vpcfile.csv"))

devtools::load_all(".")

my_settings = pmx_settings(	use.labels = TRUE,
                             cats.labels=list(STUD =c("32201.0"="C2201", "32201.1"="C2201E1"),
                                              DOSE=c("24"="24mg q4w","72"="72mg q4w",
                                                     "120"="120mg sd","240"="240mg q4w")))

my_settings_blq = pmx_settings(	use.labels = TRUE,
                            cats.labels=list(STUD =c("32201.0"="C2201", "32201.1"="C2201E1"),
                                             DOSE=c("24"="24mg q4w","72"="72mg q4w",
                                                    "120"="120mg sd","240"="240mg q4w")), sim_blq = TRUE)

ctr<-pmx_mlxtran(file_name = mlxtran_path,
                 sim= pmx_sim(file=vpc_file, irun="rep",idv="TIME"), settings = my_settings)



ctr$cats <- c("SEX","RACE","CUINDN","BAGDMF") #limit cats to listed in the analysis plan
ctr$strats <- c("DOSE","STUD") #add stratification variables

# customized labels for plots by modifying controler
ctr %>% set_abbrev( 
  IPRED = 'Individual prediction (ug/mL)', 
  PRED  = 'Population prediction (ug/mL)', 
  DV    = 'Observed QGE031 conc. (ug/mL)',
  TIME  = 'Time after first dose (days)')
```

## SIM_BLQs in ggPMX

New datasets are loaded in:
```{r}
ctr
```

```{r}
ctr$data
```



## Controller with `sim_blq = FALSE`, default

## Regular plots e.g. npde_pred

For regular plots, the dataset can be specified locally using `dname`
For example:

NPDE plot with data used from the `ctr$data$predictions` data set
```{r}
## Regular plot
ctr %>% pmx_plot_npde_pred(strat.color = "BLOQ")
```

NPDE plot with data used from the `ctr$data$merged_sim_blq` data set
```{r}
## Plot with sim_blq data
ctr %>% pmx_plot_npde_pred(dname = "merged_sim_blq", strat.color = "BLOQ")
```

The VPC is structured differently, and `dname` cannot be used in order to switch from different datasets.
In order to use sim_blq values in VPCs, `sim_blq = TRUE` can be specified.

## VPC plots

Regular VPC with data used from the `ctr$data$input` data set
```{r, fig.width=12, fig.height=8}
## Regular VPC
ctr %>% pmx_plot_vpc(bin=pmx_vpc_bin(style = "equal", within_strat = TRUE),
                     strat.facet = "DOSE",
                     filter=STUD==32201.0,
                     facets=list(scales="free"))
```

Sim_blq VPC with data used from the `ctr$data$merged_sim_blq` data set
```{r, fig.width=12, fig.height=8}
## VPC with sim_blq data
ctr %>% pmx_plot_vpc(bin=pmx_vpc_bin(style = "equal", within_strat = TRUE),
                     strat.facet = "DOSE", sim_blq =TRUE,
                     filter=STUD==32201.0,
                     facets=list(scales="free"))
```

The option can be set globally so `ctr$data$merged_sim_blq` is used in the plots if nothing else is specified.
The changes to the regular dataset can be done locally as for the examples above.
For example:
```{r, eval = FALSE}

ctr_blq<-pmx_mlxtran(file_name = mlxtran_path,
                 sim= pmx_sim(file=vpc_file, irun="rep",idv="TIME"), settings = pmx_settings(sim_blq = TRUE))
```